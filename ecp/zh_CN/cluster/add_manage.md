# 添加集群

ECP 支持通过两种方式添加集群：通过 ECP 一键部署 EMQX 集群（即托管方式）或纳管已有集群：

- 通过 ECP 一键部署 EMQX 集群，您可以体验更加丰富的集群管理功能，同时享受共享许可证和连接数等高级特性。
- 如果您已经部署了一套或几套 EMQX 集群，可以通过 ECP 的集群纳管功能管理已有集群。ECP 目前支持 EMQX v4 企业版（4.4.6 及以上）及 v5 企业版（5.6.0 及以上）的纳管。

下表为由 ECP 托管集群和纳管集群在集群管理方面的功能差异：

|功能名称|ECP 托管 v4 集群|ECP 纳管 v4 集群|ECP 纳管 v5 集群|
|:--------:|:----:|:----:|:----:|
|启停|✅|❌|❌|
|删除|✅|✅|✅|
|水平扩展|✅|❌|❌|
|垂直扩展|✅|❌|❌|
|修改网络类型|✅|❌|❌|
|修改连接数|✅|❌|✅*|
|升降级|✅|❌|❌|
|集群日志|✅|✅|✅|
|集群监控|❌|❌|✅|
|集群告警|❌|❌|✅|
|集群转移|✅|✅|✅|

\* 针对纳管的集群，**修改连接数**功能适用于 EMQX 企业版 5.7.0 及以上版本。

## ECP 托管集群

1. 以系统/组织/项目管理员的身份登录 ECP。在**工作台** -> **云端集群**页面，在集群列表页点击**添加集群**。
2. 集群类型选择**新建集群**。
3. 按集群命名规则填写**集群名称**；1-200 个字符，并支持 "-"、"_" 和空格。
4. 填写**连接数**，请注意连接数受许可和[集群资源配额](../system_admin/resource_config.md#集群资源配额)限制。
5. 选择**规格**，规格设置在请参考[集群资源配额](../system_admin/resource_config.md#集群资源配额)。
6. 选择**节点数**，当前单集群最多支持 7 个节点。
7. 选择**镜像**，镜像可以动态添加，方便用户升级，请参考 [EMQX 容器镜像列表](../system_admin/resource_config.md#emqx-容器镜像列表)和[镜像服务信息](../system_admin/resource_config.md#配置镜像服务信息)。
8. 最后，点击**确认**。

![cluster-new](./_assets/cluster-new.png)

新建集群将出现在**云端集群**的**集群列表**区域。集群状态为**更新中**，集群创建完成后，状态将变成**运行中**，即可投入生产使用。

<img src="./_assets/cluster-running.png" alt="cluster-running" style="zoom:40%;" />

## 托管集群状态

根据您业务场景的变化，您可对集群进行启停操作。

1. 以系统/组织/项目管理员的身份登录 ECP。
2. 在目标集群上，点击停止/启动。

此外，EMQX 集群状态除了上一节说到的**更新中**和**运行中**，还有如下状态：

|    状态    | 说明                                                         |
| :--------: | :----------------------------------------------------------- |
|   创建中   | 新建集群过程的中间状态                                       |
|   更新中   | 水平、垂直扩容，修改网络类型，修改连接数，集群升降级         |
|   启动中   | 点击启动服务                                                 |
|   运行中   | 集群正常运行状态                                             |
|   停止中   | 点击停止服务，或者删除集群后的中间状态                       |
|   已停止   | 停止完成，删除                                               |
| 状态同步中 | 水平、垂直扩容，集群升降级，修改网络类型，修改连接数         |
| 降级运行中 | 集群一个或多个节点不可用， 但集群整体依然可用                |
|    异常    | 集群最近的一个任务执行失败（可自动恢复），或者集群发生故障或者脏数据（极少出现该状态） |
|   不存在   | 集群创建任务没有下发成功，                                   |

如果集群状态显示为**异常**，可以进行尝试**修复**，如果修复成功，集群状态显示**运行中**；如果修复失败，请删除集群或联系 EMQ 技术支持。

## ECP 纳管现有集群

1. 以系统/组织/项目管理员的身份登录 ECP。在**工作台** -> **云端集群**页面，在集群列表页点击**添加集群**。

2. 集群类型选择**现有集群**。

3. 按集群命名规则填写**集群名称**；1-200 个字符，并支持 空格、"-"、"_"

4. 如果纳管的是 EMQX v5 集群，需要填写集群服务地址，即 EMQX dashboard 访问地址。也可以稍后通过“编辑”集群来设置集群服务地址。

5. 点击**确认**。此时集群列表会新增一个纳管的集群。

6. 在集群卡片或集群列表中，点击**注册节点**，将弹出集群注册引导页。

   

   ![cluster-running](./_assets/cluster-existing-init.png)  



7. 在注册引导页，选择 CPU 架构，当前支持 AMD64、ARM、ARM64 三种架构；按照注册引导页的提示完成注册。

   

   <img src="./_assets/cluster-existing-reg.png" style="zoom:80%;" align="middle"> 



8. 登录到 EMQX 集群安装的虚机或容器环境，例：登录到命名空间 `emqx-69f4249c` 中名称为 `emqx-69f4249c-emqx-ee-0` 的容器中；

   ```bash
   # 查看 Pod 名称
   $ kubectl -n emqx-69f4249c get pod                          
   
   NAME                     READY  STATUS   RESTARTS  AGE
   emqx-69f4249c-emax-ee-0  3/3    Running  0         28d
   
   # 进入 Pod
   $ kubectl -n emqx-69f4249c exec -it emqx-69f4249c-emqx-ee-0 -c emqx -- sh
   
   # 下载 EMQX Agent
   $ sudo curl -L -f --output /usr/local/bin/emqxee-agent https://[emqxee-agent]
   ```

9. 按顺序执行注册引导页中的命令；

   ```bash
   # 下载 EMQX Agent 
   sudo curl -L -f --output /usr/local/bin/emqxee-agent https://[emqxee-agent]
   
   # 修改 Agent 权限
   sudo chmod +x /usr/local/bin/emqxee-agent
   
   # 启动 Agent
   sudo /usr/local/bin/emqxee-agent start
   
   # 注册到 ECP
   sudo /usr/local/bin/emqxee-agent register --url https://[ecp] --registration-token bf2779e5176446cd8e18fde81d826497
   ```

10. 回到 ECP **云端集群**页，查看集群列表，可以看到被纳管的 EMQX 集群已被注册到 ECP 中，状态显示为**运行中**；

![纳管集群](./_assets/cluster-existing.png) 

11. 如果纳管的是 v4 版本集群，集群正常运行后，进入集群详情页面，在操作列将出现 **进入Dashboard** 按钮，点击后可访问集群的 dashboard。如果没有出现该按钮，请检查 ECP 配置文件中的 `cluster.agent` 是否配置正确并可被 agent 访问。
12. 如果纳管的是 v5 版本集群，正确设置集群服务地址后，在集群详情页面的操作列将出现 **进入Dashboard** 按钮，点击即可在新窗口中直接查看集群的 dashboard。

## 纳管集群状态

纳管的 EMQX 集群的状态如下：

|  状态  | 说明                                                         |
| :----: | :----------------------------------------------------------- |
| 已创建 | 新建集群，还未注册节点时的状态                               |
| 注册中 | 注册节点过程中的中间状态                                     |
| 运行中 | 集群正常运行状态                                             |
| 删除中 | 删除集群后的中间状态                                         |
|  异常  | 集群未正常运行，或者 agent 无法访问集群，或者 agent 无法与 ECP 正常通信 |

如果集群状态显示为**异常**，可以点击**异常**状态查看原因。